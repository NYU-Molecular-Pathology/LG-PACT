```{r load_reads}
# BWA original flagstat values
flagstat_df <- read.delim(file = params$flagstat_table, header = TRUE, sep = '\t') 
flagstat_df[["MappedReads"]] <- flagstat_df[["SequencedPairedReads"]]

# sambamaba/samtools dedup flagstat values
dedup_flagstat_df <- read.delim(file = params$dedup_flagstat_table, header = TRUE, sep = '\t')
dedup_flagstat_df[["DeduplicatedReads"]] <- dedup_flagstat_df[["SequencedPairedReads"]]

# sambamaba/samtools dedup log message values
dedup_df <- read.delim(file = params$reads_dedup_table, header = TRUE, sep = '\t')
dedup_df[["DuplicatedReads"]] <- dedup_df[["Duplicates"]]

# create aggregate df
reads_df <- merge(x = flagstat_df[, c("MappedReads", "Sample")], y = dedup_df[, c("DuplicatedReads", "Sample")], by = "Sample")
reads_df <- merge(x = reads_df, y = dedup_flagstat_df[, c("DeduplicatedReads", "Sample")], by = "Sample")

# sort Sample factor levels
reads_df[["Sample"]] <- factor(x = reads_df[["Sample"]], levels = sort(unique(as.character(reads_df[["Sample"]]), decreasing = TRUE)))

# convert to long format for plotting
reads_df_long <- reshape2::melt(reads_df, id.vars="Sample", variable.name="Type", value.name="Reads")

# convert to millions for plot
reads_df_long[["Reads"]] <- as.numeric(reads_df_long[["Reads"]]) / 1e6

# sort Type factor levels
reads_df_long[["Type"]] <- factor(x = reads_df_long[["Type"]], levels = sort(unique(as.character(reads_df_long[["Type"]]), decreasing = TRUE)))

# minimum number of reads required (millions)
min_reads_cutoff <- 10

mapping_plot <- ggplot(data = reads_df_long[ reads_df_long[["Type"]] %in% c("MappedReads", "DeduplicatedReads") , ], 
       aes(x = Sample, y = Reads, fill = Type)) + 
    geom_bar(stat="identity", position = "dodge") +
    geom_hline(yintercept = min_reads_cutoff, color = "red") +
    ggtitle("Sample Read Mapping") +
    coord_flip() +
    ylab("Reads (millions)") +
    theme_bw() +
    theme(panel.grid.minor = element_blank())
    
```

# Reads

```{r print_reads, results='asis'}
kable(reads_df, row.names = TRUE)
```

```{r mapping_plot}
mapping_plot
```

- Each sample must have at least `r min_reads_cutoff` million deduplicated reads to qualify for NGS580 panel analysis.

```{r}
save.image(file="reads.Rdata", compress = TRUE)
```
